<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>AI Studio Compressor è®¾ç½®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            /* é…è‰²æ–¹æ¡ˆ - Slate & Indigo */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --surface: #ffffff;
            --bg: #f8fafc;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --input-bg: #f1f5f9;
            --code-font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-main);
            line-height: 1.5;
            padding-bottom: 40px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* å¤´éƒ¨æ ·å¼ */
        header {
            margin-bottom: 32px;
            text-align: center;
        }
        header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px;
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        header p {
            color: var(--text-sub);
            font-size: 14px;
            margin: 0;
        }

        /* é¡¶éƒ¨å¯¼èˆªæŒ‰é’® */
        .nav-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
        }
        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-main);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            box-shadow: var(--shadow);
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .github-link svg {
            width: 18px;
            height: 18px;
        }
        .github-link:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 8px 20px -6px rgba(79, 70, 229, 0.4);
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title svg { width: 20px; height: 20px; color: var(--text-sub); }

        /* è¡¨å•æ§ä»¶ */
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
        }
        
        .description {
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: 12px;
            margin-top: -4px;
        }

        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            font-size: 14px;
            transition: all 0.2s;
            color: var(--text-main);
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* ç‰¹å®šè¾“å…¥æ¡†æ ·å¼ */
        textarea.code-editor {
            font-family: var(--code-font);
            font-size: 13px;
            line-height: 1.6;
            min-height: 220px;
            background: #fafafa;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }

        input.code-line {
            font-family: var(--code-font);
            background: #fafafa;
        }

        /* è®°å¿†ä¿ç•™è®¾ç½®åŒºåŸŸ */
        .memory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: var(--input-bg);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .math-explainer {
            grid-column: 1 / -1;
            font-size: 12px;
            color: var(--text-sub);
            background: rgba(255,255,255,0.5);
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px dashed var(--border);
        }
        .math-explainer strong { color: var(--primary); }

        /* æŒ‰é’®æ ·å¼ */
        .actions-bar {
            position: sticky;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: 8px;
            border: 1px solid transparent;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button.primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
        }
        button.primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

        button.secondary {
            background: white;
            border-color: var(--border);
            color: var(--text-main);
        }
        button.secondary:hover { background: var(--input-bg); border-color: #cbd5e1; }

        button.danger {
            background: white;
            border-color: #fecaca;
            color: var(--danger);
        }
        button.danger:hover { background: #fef2f2; border-color: #fca5a5; }

        button.small {
            padding: 6px 12px;
            font-size: 12px;
            height: 32px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Toast æç¤º */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none;
        }
        .toast {
            background: #1e293b;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 600px) {
            .memory-grid { grid-template-columns: 1fr; }
            .actions-bar { flex-direction: column-reverse; bottom: 0; border-radius: 0; }
            .actions-bar button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="toast-container">
        <div id="toast" class="toast">è®¾ç½®å·²ä¿å­˜</div>
    </div>

    <div class="container">
        <div class="nav-bar">
            <a class="github-link" href="https://github.com/lxchx/aistudio-compressor" target="_blank" rel="noopener noreferrer">
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 .5C5.73.5.5 5.74.5 12.02c0 5.09 3.29 9.4 7.86 10.93.58.11.8-.25.8-.57 0-.28-.01-1.02-.02-2-3.2.7-3.88-1.55-3.88-1.55-.53-1.36-1.3-1.72-1.3-1.72-1.06-.72.08-.71.08-.71 1.17.08 1.79 1.2 1.79 1.2 1.04 1.79 2.74 1.27 3.41.97.11-.75.41-1.26.74-1.55-2.56-.29-5.26-1.29-5.26-5.73 0-1.27.45-2.32 1.19-3.14-.12-.29-.52-1.45.11-3.01 0 0 .98-.32 3.21 1.2a11.1 11.1 0 0 1 5.84 0c2.23-1.52 3.21-1.2 3.21-1.2.63 1.56.23 2.72.11 3.01.74.82 1.19 1.87 1.19 3.14 0 4.46-2.7 5.44-5.28 5.73.42.36.8 1.08.8 2.19 0 1.58-.01 2.85-.01 3.24 0 .31.21.68.81.57A10.52 10.52 0 0 0 23.5 12C23.5 5.74 18.27.5 12 .5Z"/>
                </svg>
                <span>GitHub é¡¹ç›®ä¸»é¡µ</span>
            </a>
        </div>
        <header>
            <h1>Compressor æ§åˆ¶å°</h1>
            <p>è‡ªå®šä¹‰ AI Studio å†å²è®°å½•å‹ç¼©é€»è¾‘ä¸è®°å¿†ä¿ç•™ç­–ç•¥</p>
        </header>

        <form id="compressor-settings-form">
            <!-- Prompt è®¾ç½®å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        å‹ç¼©æŒ‡ä»¤ (System Prompt)
                    </span>
                    <div style="display:flex; gap:8px;">
                        <button type="button" class="secondary small" id="btn-copy-prompt" title="å¤åˆ¶å½“å‰å†…å®¹">å¤åˆ¶</button>
                        <button type="button" class="secondary small" id="btn-prompt-reset" title="é‡ç½®ä¸ºåˆå§‹é»˜è®¤ Prompt">æ¢å¤é»˜è®¤</button>
                    </div>
                </div>
                <div class="description">
                    è¿™æ˜¯å‘é€ç»™ AI çš„æ ¸å¿ƒæŒ‡ä»¤ã€‚å®šä¹‰äº† XML è¾“å‡ºç»“æ„ `<state_snapshot>` åŠå…¶åŒ…å«çš„å­—æ®µã€‚
                </div>
                <textarea id="field-prompt" name="compressPrompt" class="code-editor" spellcheck="false"></textarea>
            </div>

            <!-- æ­£åˆ™åŒ¹é…å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                        </svg>
                        ç»“æœæå–æ­£åˆ™ (Regex)
                    </span>
                </div>
                <div class="description">
                    ç”¨äºä» AI å›å¤ä¸­ç²¾å‡†æå– XML å†…å®¹ã€‚è‹¥ç•™ç©ºåˆ™å°è¯•æå–æ•´ä¸ªå›å¤ã€‚
                </div>
                <input id="field-regex" class="code-line" name="snapshotRegex" type="text" placeholder="<state_snapshot>[\s\S]*?</state_snapshot>" />
            </div>

            <!-- å†å²è®°å½•ç­–ç•¥å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        å†å²æ¶ˆæ¯è£å‰ªç­–ç•¥
                    </span>
                </div>
                <div class="memory-grid">
                    <div class="math-explainer">
                        <span>ğŸ’¡ è®¡ç®—é€»è¾‘ï¼šä¿ç•™å­—æ•° = MAX ( <strong>æ€»å­—æ•° Ã— ç™¾åˆ†æ¯”</strong> , <strong>æœ€å°‘ä¿ç•™å­—æ•°</strong> )</span>
                    </div>
                    <div>
                        <label>ä¿ç•™å°¾éƒ¨ç™¾åˆ†æ¯” (%)</label>
                        <input id="field-percent" name="tailPercent" type="number" min="0" max="100" step="1" />
                        <div class="description" style="margin-top:6px; font-size:12px;">å»ºè®® 20-50 ä¹‹é—´</div>
                    </div>
                    <div>
                        <label>æœ€å°‘ä¿ç•™å­—ç¬¦æ•° (Chars)</label>
                        <input id="field-minchars" name="tailMinChars" type="number" min="0" step="100" />
                        <div class="description" style="margin-top:6px; font-size:12px;">é˜²æ­¢çŸ­å¯¹è¯è¢«è¿‡åº¦å‹ç¼©</div>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æ“ä½œæ  -->
            <div class="actions-bar">
                <div style="margin-right: auto;">
                    <button type="button" class="danger" id="btn-reset">å…¨éƒ¨é‡ç½®</button>
                </div>
                <button type="button" class="secondary" id="btn-close">å…³é—­</button>
                <button type="submit" class="primary">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
            </div>
        </form>
    </div>

    <script>
        // --- Constants & Defaults ---
        const DEFAULT_SETTINGS = {
            compressPrompt: `That concludes the above topic. Please remember the chat history and switch roles:
            
  You are the component that summarizes internal chat history into a given structure.

  When the conversation history grows too large, you will be invoked to distill the entire history into a concise, structured
  XML snapshot. This snapshot is CRITICAL, as it will become the agent's *only* memory of the past. The agent will resume its
  work based solely on this snapshot. All crucial details, plans, errors, and user directives MUST be preserved.

  First, you will think through the entire history in a private <scratchpad>. Review the user's overall goal, the agent's
  actions, tool outputs, file modifications, and any unresolved questions. Identify every piece of information that is essential
  for future actions.

  After your reasoning is complete, generate the final <state_snapshot> XML object. Be incredibly dense with information. Omit
  any irrelevant conversational filler.

  The structure MUST be as follows:

  <state_snapshot>
      <overall_goal>
          <!-- A single, concise sentence describing the user's high-level objective. -->
          <!-- Example: "Refactor the authentication service to use a new JWT library." -->
      </overall_goal>

      <key_knowledge>
          <!-- Crucial facts, conventions, and constraints the agent must remember based on the conversation history and
  interaction with the user. Use bullet points. -->
          <!-- Example:
           - Build Command: \`npm run build\`
           - Testing: Tests are run with \`npm test\`. Test files must end in \`.test.ts\`.
           - API Endpoint: The primary API endpoint is \`https://api.example.com/v2\`.

          -->
      </key_knowledge>

      <file_system_state>
          <!-- List files that have been created, read, modified, or deleted. Note their status and critical learnings. -->
          <!-- Example:
           - CWD: \`/home/user/project/src\`
           - READ: \`package.json\` - Confirmed 'axios' is a dependency.
           - MODIFIED: \`services/auth.ts\` - Replaced 'jsonwebtoken' with 'jose'.
           - CREATED: \`tests/new-feature.test.ts\` - Initial test structure for the new feature.
          -->
      </file_system_state>

      <recent_actions>
          <!-- A summary of the last few significant agent actions and their outcomes. Focus on facts. -->
          <!-- Example:
           - Ran \`grep 'old_function'\` which returned 3 results in 2 files.
           - Ran \`npm run test\`, which failed due to a snapshot mismatch in \`UserProfile.test.ts\`.
           - Ran \`ls -F static/\` and discovered image assets are stored as \`.webp\`.
          -->
      </recent_actions>

      <current_plan>
          <!-- The agent's step-by-step plan. Mark completed steps. -->
          <!-- Example:
           1. [DONE] Identify all files using the deprecated 'UserAPI'.
           2. [IN PROGRESS] Refactor \`src/components/UserProfile.tsx\` to use the new 'ProfileAPI'.
           3. [TODO] Refactor the remaining files.
           4. [TODO] Update tests to reflect the API change.
          -->
      </current_plan>
  </state_snapshot>`,
            snapshotRegex: "",
            tailPercent: 30,
            tailMinChars: 2000
        };
        const STORAGE_KEY = "aistudio_compressor_settings_preview";

        // --- Elements ---
        const form = document.getElementById("compressor-settings-form");
        const promptField = document.getElementById("field-prompt");
        const regexField = document.getElementById("field-regex");
        const percentField = document.getElementById("field-percent");
        const minCharsField = document.getElementById("field-minchars");
        
        const closeBtn = document.getElementById("btn-close");
        const resetBtn = document.getElementById("btn-reset");
        const promptResetBtn = document.getElementById("btn-prompt-reset");
        const copyBtn = document.getElementById("btn-copy-prompt");
        const toastEl = document.getElementById("toast");

        // --- Utils ---
        function showToast(message) {
            toastEl.textContent = message;
            toastEl.classList.add("show");
            setTimeout(() => toastEl.classList.remove("show"), 2500);
        }

        function loadSettings() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return { ...DEFAULT_SETTINGS };
                const parsed = JSON.parse(raw);
                return { ...DEFAULT_SETTINGS, ...parsed };
            } catch (err) {
                console.warn("Failed to load preview settings", err);
                return { ...DEFAULT_SETTINGS };
            }
        }

        function saveSettings(settings) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            } catch (err) {
                console.warn("Failed to store preview settings", err);
            }
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({
                    source: "aistudio-compressor",
                    type: "update-settings",
                    payload: settings
                }, "*");
            }
        }

        function populateForm(settings) {
            promptField.value = settings.compressPrompt;
            regexField.value = settings.snapshotRegex || "";
            percentField.value = settings.tailPercent;
            minCharsField.value = settings.tailMinChars;
            updatePromptResetState();
        }

        function updatePromptResetState() {
            const isDefault = promptField.value.trim() === DEFAULT_SETTINGS.compressPrompt.trim();
            promptResetBtn.disabled = isDefault;
            promptResetBtn.style.opacity = isDefault ? "0.5" : "1";
        }

        // --- Event Listeners ---

        form.addEventListener("submit", event => {
            event.preventDefault();
            const parsedPercent = Number(percentField.value);
            const normalizedPercent = Number.isFinite(parsedPercent) ? Math.min(Math.max(parsedPercent, 0), 100) : DEFAULT_SETTINGS.tailPercent;
            const parsedMinChars = Number(minCharsField.value);
            const normalizedMinChars = Number.isFinite(parsedMinChars) && parsedMinChars >= 0 ? Math.floor(parsedMinChars) : DEFAULT_SETTINGS.tailMinChars;
            
            const settings = {
                compressPrompt: promptField.value.trim() || DEFAULT_SETTINGS.compressPrompt,
                snapshotRegex: regexField.value.trim(),
                tailPercent: normalizedPercent,
                tailMinChars: normalizedMinChars
            };
            saveSettings(settings);
            showToast("âœ… è®¾ç½®å·²ä¿å­˜");
        });

        promptField.addEventListener("input", updatePromptResetState);

        promptResetBtn.addEventListener("click", () => {
            promptField.value = DEFAULT_SETTINGS.compressPrompt;
            updatePromptResetState();
            showToast("ğŸ”„ Prompt å·²æ¢å¤é»˜è®¤");
        });

        copyBtn.addEventListener("click", () => {
            if (!promptField.value) return;
            navigator.clipboard.writeText(promptField.value).then(() => {
                showToast("ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
            }).catch(() => showToast("âŒ å¤åˆ¶å¤±è´¥"));
        });

        resetBtn.addEventListener("click", () => {
            if (!confirm("ç¡®å®šè¦å°†æ‰€æœ‰è®¾ç½®æ¢å¤ä¸ºåˆå§‹çŠ¶æ€å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) return;
            saveSettings({ ...DEFAULT_SETTINGS });
            populateForm(DEFAULT_SETTINGS);
            showToast("â™»ï¸ å·²æ¢å¤æ‰€æœ‰é»˜è®¤è®¾ç½®");
        });

        closeBtn.addEventListener("click", () => window.close());

        window.addEventListener("message", event => {
            if (!event.data || event.data.source !== "aistudio-compressor") return;
            if (event.data.type === "hydrate" && event.data.payload) {
                populateForm({ ...DEFAULT_SETTINGS, ...event.data.payload });
                showToast("ğŸ“¥ å·²åŒæ­¥å¤–éƒ¨è®¾ç½®");
            }
        });

        // --- Init ---
        populateForm(loadSettings());
    </script>
</body>
</html>
